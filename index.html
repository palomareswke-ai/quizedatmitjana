<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Joc: L'Edat Mitjana ‚Äî PWA</title>
  <meta name="theme-color" content="#7c3aed" />
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icons/icon-192.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .emoji-small { font-size: 1.6rem; line-height: 1; }
    .num-badge { font-weight: 700; width: 2rem; display:inline-block; text-align:center; }
    .card-shadow { box-shadow: 0 10px 30px rgba(0,0,0,0.12); }
    .correct-glow { animation: correctPulse 0.9s ease forwards; }
    .wrong-shake { animation: wrongShake .6s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes correctPulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    @keyframes wrongShake { 10%,90%{transform:translateX(-2px);}20%,80%{transform:translateX(4px);} }
    .answer-btn{ transition: transform .12s, box-shadow .12s }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-amber-50 min-h-screen flex items-center justify-center p-4">

  <div id="app" class="w-full max-w-2xl"></div>

<script>
/* ---- SOURCE TEXT ---- */
const SOURCE_TEXT = `La Edad Mitjana √©s una √®poca de la hist√≤ria que va comen√ßar despr√©s de l'Imperi Rom√† i va acabar quan van descobrir Am√®rica.
Durant aquest temps:
Els castells eren molt importants. Hi vivien els reis, els nobles i els cavallers.
A prop dels castells hi havia els pobles, on vivien els pagesos, que treballaven al camp.
Les ciutats eren petites i moltes vegades tenien muralles per protegir-se.
Les persones resaven a D√©u i anaven a l'esgl√©sia. Els monjos vivien als monestirs, on copiaven llibres i estudiaven.
No hi havia m√†quines ni llum el√®ctrica, i les persones feien servir animals per treballar i espelmes per il¬∑luminar-se.
Cap al final de l'Edat Mitjana, les ciutats van cr√©ixer, van apar√®ixer els mercats i es van comen√ßar a fer viatges per comerciar`;

/* ---- SOUNDS: try pixabay then fallback (prevents 403 console errors) ---- */
const soundCorrect = new Audio();
const PIXABAY_TRY = "https://cdn.pixabay.com/download/audio/2021/09/20/audio_84f81f8d42.mp3";
const FALLBACK_CORRECT = "https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg";
soundCorrect.src = PIXABAY_TRY;
soundCorrect.addEventListener('error', () => { soundCorrect.src = FALLBACK_CORRECT; });
const soundWrong = new Audio("https://actions.google.com/sounds/v1/cartoon/boing.ogg");
const soundClick = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

/* ---- 50 QUESTIONS ---- */
const ALL_QUESTIONS = [
  { q: "Qu√® va comen√ßar despr√©s de l'Imperi Rom√†?", choices: ["L'Edat Mitjana üï∞Ô∏è","La prehist√≤ria ü¶¥","El futur ü§ñ"], correctIndex:0 },
  { q: "Quan va acabar l'Edat Mitjana segons el text?", choices: ["Quan van descobrir Am√®rica üó∫Ô∏è","Quan es va inventar la televisi√≥ üì∫","Quan va acabar la guerra mundial ‚öîÔ∏è"], correctIndex:0 },
  { q: "Qu√® era molt important a l'Edat Mitjana?", choices: ["Els castells üè∞","Els gratacels üè¢","Les f√†briques üè≠"], correctIndex:0 },
  { q: "Qui vivia als castells?", choices: ["Reis i nobles üëë","Pagesos üåæ","Pescadors üé£"], correctIndex:0 },
  { q: "Qui tamb√© vivia als castells a part dels reis?", choices: ["Cavallers üõ°Ô∏è","Taxistes üöï","Pilots ‚úàÔ∏è"], correctIndex:0 },
  { q: "On vivien la majoria de pagesos?", choices: ["Als pobles prop dels castells üèòÔ∏è","Als edificis moderns üè¢","A les estacions üöâ"], correctIndex:0 },
  { q: "Qu√® feien els pagesos?", choices: ["Treballaven al camp üåæ","Feien experiments üî¨","Condu√Øen cotxes üöó"], correctIndex:0 },
  { q: "Com eren moltes ciutats a l'Edat Mitjana?", choices: ["Petites i amb muralles üß±","Immenses com ara üèôÔ∏è","Sota l'aigua üåä"], correctIndex:0 },
  { q: "Per qu√® tenien muralles les ciutats?", choices: ["Per protegir-se üõ°Ô∏è","Per decorar üé®","Per fer esport üèÖ"], correctIndex:0 },
  { q: "On anaven les persones a resar?", choices: ["A l'esgl√©sia ‚õ™","A la platja üèñÔ∏è","Al parc üå≥"], correctIndex:0 },

  { q: "Qui vivia als monestirs?", choices: ["Monjos üìú","Policia üëÆ","Kids üéí"], correctIndex:0 },
  { q: "Qu√® feien sovint els monjos amb els llibres?", choices: ["Els copiaven ‚úçÔ∏è","Els cremaven üî•","Els llen√ßaven üóëÔ∏è"], correctIndex:0 },
  { q: "Els monjos estudiaven i...", choices: ["Copiaven llibres üìö","Jugaven ordinadors üíª","Anaven al cine üé¨"], correctIndex:0 },
  { q: "Hi havia llum el√®ctrica a l'Edat Mitjana?", choices: ["No, no hi havia llum el√®ctrica ‚ö°‚ùå","S√≠, com ara üí°‚úÖ","Nom√©s a algunes cases üè†"], correctIndex:0 },
  { q: "Amb qu√® s'il¬∑luminaven sovint?", choices: ["Amb espelmes üïØÔ∏è","Amb bombetes üí°","Amb l√†sers üî¶"], correctIndex:0 },
  { q: "Qu√® feien servir per treballar al camp?", choices: ["Animals de tir i c√†rrega üêÇ","Robots ü§ñ","Autom√≤bils üöó"], correctIndex:0 },
  { q: "Cap al final de l'Edat Mitjana qu√® passava amb les ciutats?", choices: ["Van cr√©ixer üèôÔ∏è","Van desapar√®ixer üí®","Van volar ‚òÅÔ∏è"], correctIndex:0 },
  { q: "Qu√® va apar√®ixer a les ciutats al final de l'√®poca?", choices: ["Mercats i comer√ß üõçÔ∏è","Coets espacials üöÄ","Cotxes de f√≥rmula 1 üèéÔ∏è"], correctIndex:0 },
  { q: "Per qu√® es feien viatges cap al final de l'Edat Mitjana?", choices: ["Per comerciar i viatjar ‚õµ","Per anar de vacances a la Lluna üåï","Per fer esports n√†utics üèÑ"], correctIndex:0 },
  { q: "Com eren algunes ciutats moltes vegades?", choices: ["Amb muralles per protegir-se üß±","Amb Wi-Fi gratis üì∂","Amb rutes de tramvia üöã"], correctIndex:0 },

  { q: "Qu√® no existia en aquell temps?", choices: ["L'electricitat a casa ‚ö°‚ùå","Els animals üêÆ","Els castells üè∞"], correctIndex:0 },
  { q: "On vivien moltes persones religioses?", choices: ["Als monestirs üèõÔ∏è","Als centres comercials üè¨","Als laboratoris üî¨"], correctIndex:0 },
  { q: "Qu√® feien servir per il¬∑luminar-se a casa?", choices: ["Espelmes üïØÔ∏è","Pantalles LED üí°","Rellotges intel¬∑ligents ‚åö"], correctIndex:0 },
  { q: "Els monjos sovint eren‚Ä¶", choices: ["Estudiants i copistes üìñ","Pilots d'avi√≥ ‚úàÔ∏è","Cantants famosos üé§"], correctIndex:0 },
  { q: "Quin lloc era central en la vida religiosa?", choices: ["L'esgl√©sia ‚õ™","El gimn√†s üèãÔ∏è","El centre comercial üõí"], correctIndex:0 },
  { q: "Els castells estaven relacionats amb‚Ä¶", choices: ["Reis i nobles üëë","Estacions de tren üöâ","Parcs d'atraccions üé°"], correctIndex:0 },
  { q: "Quin element apareix a la frase 'van comen√ßar a fer viatges per‚Ä¶'?", choices: ["Comerciar i mercaderies üß≠","Jugar a videojocs üéÆ","Navegar en coets üöÄ"], correctIndex:0 },
  { q: "Com es deia la gent que treballava el camp?", choices: ["Pagesos üåæ","Monjos üìú","Nobles üëë"], correctIndex:0 },
  { q: "A prop de qu√® vivien els pobles?", choices: ["A prop dels castells üè∞","A prop dels aer√≤droms ‚úàÔ∏è","A prop de les autopistes üõ£Ô∏è"], correctIndex:0 },
  { q: "Les ciutats s'estaven fent al final de l'Edat Mitjana?", choices: ["S√≠, van cr√©ixer i van tenir mercats üèôÔ∏è","No, van escur√ßar-se ü™ì","Van desapar√®ixer en massa üí®"], correctIndex:0 },

  { q: "Qu√® feien les persones per resar?", choices: ["Anar a l'esgl√©sia ‚õ™","Anar al cine üé¨","Anar a la biblioteca üìö"], correctIndex:0 },
  { q: "Els monestirs eren llocs on‚Ä¶", choices: ["Es copiaven llibres i s'estudiava üìö","Es fabricaven cotxes üöó","Es jugaven esports üèÖ"], correctIndex:0 },
  { q: "Quina era una font d'il¬∑luminaci√≥ casolana?", choices: ["Espelma üïØÔ∏è","Foco LED üí°","Flash d'un m√≤bil üì±"], correctIndex:0 },
  { q: "Les persones utilitzaven animals per‚Ä¶", choices: ["Treballar al camp i transportar c√†rregues üê¥","Fer esports ecuestres üèá","Fer experiments cient√≠fics üî¨"], correctIndex:0 },
  { q: "Quina activitat comercial va cr√©ixer cap al final de l'Edat Mitjana?", choices: ["Mercats i comer√ß üõçÔ∏è","Streaming en directe üì∫","Automoci√≥ massiva üöó"], correctIndex:0 },
  { q: "Per qu√® els mercaders viatjaven?", choices: ["Per comerciar amb altres llocs üõí","Per fer fotos üì∏","Per protestar ü™ß"], correctIndex:0 },
  { q: "Les ciutats en general eren‚Ä¶", choices: ["Petites sovint üèòÔ∏è","Molt grans com ara üèôÔ∏è","Totalment deshabitades üö´"], correctIndex:0 },
  { q: "On vivien sovint els nobles?", choices: ["Als castells amb els reis üëë","Als xalets a la platja üèñÔ∏è","Als apartaments moderns üè¢"], correctIndex:0 },
  { q: "Qui eren responsables de protegir el castell?", choices: ["Cavallers i nobles üõ°Ô∏è","Pagesos üåæ","Comerciants üß∫"], correctIndex:0 },
  { q: "Quina cosa NO era t√≠pica d'aquella √®poca?", choices: ["Llum el√®ctrica a totes les cases üí°‚ùå","Monestirs amb monjos üìú","Pobles amb pagesos üè°"], correctIndex:0 },

  { q: "Com es deia el lloc on vivien els monjos?", choices: ["Monestir üìò","Aer√≤drom ‚úàÔ∏è","Platja üèñÔ∏è"], correctIndex:0 },
  { q: "Qu√® feien servir per protegir les ciutats?", choices: ["Muralles i defenses üß±","Parcs infantils üõù","Centres comercials üè¨"], correctIndex:0 },
  { q: "Quin element s'associa a la il¬∑luminaci√≥ casolana?", choices: ["Espelmes üïØÔ∏è","Llums LED modernes üí°","Llanternes solars üåû"], correctIndex:0 },
  { q: "Qui vivia als pobles al voltant dels castells?", choices: ["Pagesos i fam√≠lies üåæ","Pilots d'avi√≥ ‚úàÔ∏è","Programadors üíª"], correctIndex:0 },
  { q: "Qu√® era una ocupaci√≥ habitual dels pagesos?", choices: ["Treballar el camp i conrear üå±","Programar jocs üéÆ","Tenir oficines banc√†ries üè¶"], correctIndex:0 },
  { q: "Cap a quin moment van comen√ßar els mercats i viatges comercials?", choices: ["Cap al final de l'Edat Mitjana üï∞Ô∏è","Al principi de la prehist√≤ria ü¶¥","Fa 1 any üìÜ"], correctIndex:0 },
  { q: "Qu√® es feia sovint amb els llibres als monestirs?", choices: ["Copiar-los a m√† ‚úçÔ∏è","Posar-los a l'ordinador üíª","Vendre'ls a la r√†dio üìª"], correctIndex:0 },
  { q: "Quin era un recurs per treballar el s√≤l abans de m√†quines?", choices: ["Animals de c√†rrega i tracci√≥ üêÇ","Tractors moderns üöú","Grues mec√†niques üèóÔ∏è"], correctIndex:0 },
  { q: "Quina afirmaci√≥ √©s correcta segons el text?", choices: ["Les ciutats van cr√©ixer cap al final de l'Edat Mitjana üèôÔ∏è","Les ciutats mai no van existir üèöÔ∏è","Les ciutats semblaven coets üöÄ"], correctIndex:0 },
  { q: "On es trobaven molts mercats?", choices: ["A les ciutats en creixement üõçÔ∏è","A l'espai exterior üåå","A la lluna üåô"], correctIndex:0 }
];

/* ---- helpers ---- */
function shuffleArray(a){ for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function splitEmojiFromText(str){ const s=String(str).trim(); if(!s) return {text:'',emoji:null}; const parts=s.split(' '); const last=parts[parts.length-1]; if(/[^A-Za-z0-9\s,\.]/.test(last)){ parts.pop(); return { text: parts.join(' ').trim(), emoji: last }; } return { text: s, emoji: null }; }
function escapeHtml(u){ return String(u).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* ---- render UI ---- */
const app = document.getElementById('app');
app.innerHTML = `
  <div id="screen-start" class="card-shadow bg-white rounded-2xl p-8 text-center">
    <div class="text-6xl mb-3">üè∞</div>
    <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">Joc: L'Edat Mitjana</h1>
    <p class="text-gray-600 mb-6">Preguntes f√†cils per a nens i nenes. Cada partida: 5 preguntes.</p>
    <div class="flex flex-col sm:flex-row gap-3 justify-center">
      <button id="btn-start" class="px-6 py-3 rounded-xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700">Comen√ßar</button>
      <button id="btn-view-text" class="px-6 py-3 rounded-xl bg-amber-400 text-amber-900 font-semibold shadow hover:bg-amber-500">Veure text original</button>
      <button id="btn-history" class="px-6 py-3 rounded-xl bg-green-400 text-green-900 font-semibold shadow hover:bg-green-500">Historial</button>
    </div>
  </div>

  <div id="modal-text" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full p-6">
      <div class="flex justify-between items-start">
        <h2 class="text-xl font-bold text-indigo-700">Text original</h2>
        <button id="close-text" class="text-gray-500 hover:text-gray-800">Tancar ‚úñ</button>
      </div>
      <div class="mt-4 text-gray-800 leading-relaxed"><pre class="whitespace-pre-wrap">${escapeHtml(SOURCE_TEXT)}</pre></div>
    </div>
  </div>

  <div id="modal-history" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full p-6">
      <div class="flex justify-between items-start">
        <h2 class="text-xl font-bold text-green-700">Historial de puntuacions</h2>
        <div class="flex gap-2">
          <button id="btn-clear-history" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded">Esborrar</button>
          <button id="close-history" class="text-gray-500 hover:text-gray-800">Tancar ‚úñ</button>
        </div>
      </div>
      <div id="history-list" class="mt-4 text-gray-800 max-h-64 overflow-auto"></div>
    </div>
  </div>

  <div id="screen-game" class="hidden mt-6">
    <div class="bg-white rounded-2xl p-6 card-shadow">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="text-4xl">üß≠</div>
          <div>
            <div class="text-sm text-gray-500">Pregunta <span id="q-index">1</span> / 5</div>
            <div id="progress" class="w-48 h-2 bg-gray-200 rounded-full mt-2 overflow-hidden"><div id="progress-bar" class="h-full bg-indigo-500 w-0"></div></div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-600">Aciertos: <span id="score-correct">0</span></div>
          <div class="text-sm text-gray-600">Errors: <span id="score-wrong">0</span></div>
        </div>
      </div>

  <div id="card" class="rounded-lg p-6 bg-gradient-to-br from-white to-slate-50 border border-gray-100 card-shadow">
    <div class="mb-4">
      <div class="text-2xl font-semibold text-indigo-700 mb-3" id="question-text">Pregunta aqu√≠</div>
      <div class="text-sm text-gray-500 mb-2">Escull la resposta: 1, 2 o 3</div>
    </div>

    <div id="answers" class="grid gap-3"></div>

    <div class="mt-5 flex justify-between items-center">
      <div class="text-sm text-gray-500">Utilitza 1-2-3 o el ratol√≠</div>
      <div class="flex gap-3">
        <button id="btn-accept" class="px-5 py-2 rounded-xl bg-indigo-600 text-white font-semibold disabled:opacity-50" disabled>Acceptar</button>
        <button id="btn-next" class="px-5 py-2 rounded-xl bg-gray-300 text-gray-800 hidden">Seg√ºent pregunta</button>
      </div>
    </div>
  </div>
</div>

  <div id="screen-result" class="hidden mt-6">
    <div class="bg-white rounded-2xl p-6 card-shadow text-center">
      <div class="text-6xl mb-3" id="result-emoji">üéâ</div>
      <h3 class="text-2xl font-extrabold text-indigo-700" id="result-title">Has acabat!</h3>
      <p class="mt-2 text-gray-700">Aciertos: <span id="final-correct">0</span> ‚Äî Errors: <span id="final-wrong">0</span></p>

      <div class="mt-6 flex justify-center gap-3">
        <button id="btn-play-again" class="px-5 py-2 rounded-xl bg-indigo-600 text-white">Jugar de nou</button>
        <button id="btn-back-home" class="px-5 py-2 rounded-xl bg-amber-400 text-amber-900">Tornar</button>
      </div>
    </div>
  </div>
`;

/* ---- game logic (same behaviour requested) ---- */
const STORAGE_KEY = 'medieval_quiz_pwa_scores';
let gameQuestions = [];
let currentQ = 0;
let selectedAnswerIndex = null;
let scoreCorrect = 0;
let scoreWrong = 0;
let shuffledChoices = [];

const btnStart = document.getElementById('btn-start');
const btnViewText = document.getElementById('btn-view-text');
const modalText = document.getElementById('modal-text');
const closeText = document.getElementById('close-text');
const btnHistory = document.getElementById('btn-history');
const modalHistory = document.getElementById('modal-history');
const closeHistory = document.getElementById('close-history');
const btnClearHistory = document.getElementById('btn-clear-history');

const qIndexEl = document.getElementById('q-index');
const progressBar = document.getElementById('progress-bar');
const questionText = document.getElementById('question-text');
const answersDiv = document.getElementById('answers');
const btnAccept = document.getElementById('btn-accept');
const btnNext = document.getElementById('btn-next');
const scoreCorrectEl = document.getElementById('score-correct');
const scoreWrongEl = document.getElementById('score-wrong');

const resultEmoji = document.getElementById('result-emoji');
const resultTitle = document.getElementById('result-title');
const finalCorrect = document.getElementById('final-correct');
const finalWrong = document.getElementById('final-wrong');
const btnPlayAgain = document.getElementById('btn-play-again');
const btnBackHome = document.getElementById('btn-back-home');

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function splitEmojiFromTextLocal(str){ const s=String(str).trim(); if(!s) return {text:'',emoji:null}; const parts=s.split(' '); const last=parts[parts.length-1]; if(/[^A-Za-z0-9\s,\.]/.test(last)){ parts.pop(); return {text:parts.join(' ').trim(), emoji:last}; } return {text:s, emoji:null}; }
function escapeHtmlLocal(u){ return String(u).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* events */
btnStart.addEventListener('click', ()=>{ try{ soundClick.currentTime=0; soundClick.play(); }catch(e){}; startGame(); });
btnViewText.addEventListener('click', ()=>{ modalText.classList.remove('hidden'); });
closeText.addEventListener('click', ()=> modalText.classList.add('hidden'));
btnPlayAgain.addEventListener('click', ()=>{ try{ soundClick.currentTime=0; soundClick.play(); }catch(e){}; startGame(); });
btnBackHome.addEventListener('click', ()=> showScreen('start'));
btnAccept.addEventListener('click', ()=> { if(selectedAnswerIndex===null) return; verifyAnswer(); });
btnNext.addEventListener('click', ()=> { btnNext.classList.add('hidden'); proceedToNext(); });

function startGame(){
  const copy = ALL_QUESTIONS.map((q,idx)=>({...q,id:idx}));
  shuffle(copy);
  gameQuestions = copy.slice(0,5);
  currentQ = 0;
  scoreCorrect = 0;
  scoreWrong = 0;
  selectedAnswerIndex = null;
  scoreCorrectEl.textContent='0';
  scoreWrongEl.textContent='0';
  progressBar.style.width='0%';
  showScreen('game');
  renderQuestion();
}

function renderQuestion(){
  const qObj = gameQuestions[currentQ];
  qIndexEl.textContent = (currentQ+1);
  progressBar.style.width = ((currentQ/5)*100)+'%';
  questionText.textContent = qObj.q;
  answersDiv.innerHTML = '';
  selectedAnswerIndex = null;
  btnAccept.disabled = true;
  btnNext.classList.add('hidden');

  const originalChoices = qObj.choices.map((c,i)=>({text:c,orig:i}));
  shuffledChoices = shuffle(originalChoices.slice());

  shuffledChoices.forEach((choice,i)=>{ const {text,emoji} = splitEmojiFromTextLocal(choice.text); const displayEmoji = emoji || 'üîπ'; const displayText = text || choice.text; const btn = document.createElement('button'); btn.type='button'; btn.className='answer-btn text-left border rounded-lg px-4 py-3 hover:scale-[1.01] transition flex items-center gap-3 bg-white text-gray-800'; btn.innerHTML = `<span class="num-badge">${i+1}</span><span class="emoji-small">${displayEmoji}</span><span class="flex-1">${escapeHtmlLocal(displayText)}</span>`; btn.addEventListener('click', ()=>{ const all = answersDiv.querySelectorAll('button'); all.forEach(b=>b.classList.remove('ring-2','ring-indigo-300')); btn.classList.add('ring-2','ring-indigo-300'); selectedAnswerIndex = i; btnAccept.disabled = false; }); answersDiv.appendChild(btn); });

function verifyAnswer(){ const qObj = gameQuestions[currentQ]; const chosenOriginalIndex = shuffledChoices[selectedAnswerIndex].orig; const isCorrect = chosenOriginalIndex === qObj.correctIndex; const card = document.getElementById('card'); const btns = answersDiv.querySelectorAll('button'); btns.forEach(b=>b.disabled=true); btnAccept.disabled=true; if(isCorrect){ scoreCorrect++; scoreCorrectEl.textContent = scoreCorrect; card.classList.add('correct-glow'); try{ soundCorrect.currentTime = 0; soundCorrect.play(); }catch(e){}; btns[selectedAnswerIndex].classList.add('bg-green-100','border-green-300'); setTimeout(()=>{ card.classList.remove('correct-glow'); proceedToNext(); },900); } else { scoreWrong++; scoreWrongEl.textContent = scoreWrong; card.classList.add('wrong-shake'); try{ soundWrong.currentTime = 0; soundWrong.play(); }catch(e){}; btns.forEach((b,i)=>{ const orig = shuffledChoices[i].orig; if(orig===qObj.correctIndex){ b.classList.add('bg-green-100','border-green-300'); } else if(i===selectedAnswerIndex){ b.classList.add('bg-red-100','border-red-300'); } else { b.classList.add('bg-gray-50'); } }); btnNext.classList.remove('hidden'); setTimeout(()=>{ card.classList.remove('wrong-shake'); },700); } }

function proceedToNext(){ currentQ++; if(currentQ>=5) finishGame(); else renderQuestion(); }

function finishGame(){ progressBar.style.width = '100%'; finalCorrect.textContent = scoreCorrect; finalWrong.textContent = scoreWrong; if(scoreCorrect >= 4){ resultEmoji.textContent='üèÜ'; resultTitle.textContent='Super! Molt b√©!'; } else if(scoreCorrect >= 2){ resultEmoji.textContent='üôÇ'; resultTitle.textContent='Bona feina!'; } else { resultEmoji.textContent='ü§î'; resultTitle.textContent="Hem d'estudiar una mica m√©s"; } saveScore({ date: new Date().toISOString(), correct: scoreCorrect, wrong: scoreWrong }); showScreen('result'); }

function showScreen(name){ document.getElementById('screen-start').classList.toggle('hidden', name !== 'start'); document.getElementById('screen-game').classList.toggle('hidden', name !== 'game'); document.getElementById('screen-result').classList.toggle('hidden', name !== 'result'); if(name === 'start') progressBar.style.width='0%'; }

function getHistory(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
function saveScore(obj){ const hist = getHistory(); hist.unshift(obj); localStorage.setItem(STORAGE_KEY, JSON.stringify(hist.slice(0,50))); }
function renderHistory(){ const list = getHistory(); const container = document.getElementById('history-list'); container.innerHTML = ''; if(!list.length){ container.innerHTML = '<p class="text-gray-600">No hi ha resultats. Juga una partida!</p>'; return; } const ul = document.createElement('ul'); ul.className = 'space-y-2'; list.forEach((s,i)=>{ const li = document.createElement('li'); const date = new Date(s.date); li.innerHTML = `<div class="p-3 bg-gray-50 rounded flex justify-between items-center"> <div><div class="text-sm font-medium">Partida ${list.length - i}</div><div class="text-xs text-gray-500">Data: ${date.toLocaleString()}</div></div> <div class="text-sm"><span class="font-semibold text-green-600">${s.correct}</span> ‚úî ‚Äî <span class="font-semibold text-red-600">${s.wrong}</span> ‚úñ</div> </div>`; ul.appendChild(li); }); container.appendChild(ul); }

showScreen('start');
try{ soundClick.load(); soundCorrect.load(); soundWrong.load(); }catch(e){}
document.addEventListener('click',(e)=>{ const mt=document.getElementById('modal-text'); const mh=document.getElementById('modal-history'); if(mt && !mt.classList.contains('hidden') && e.target===mt) mt.classList.add('hidden'); if(mh && !mh.classList.contains('hidden') && e.target===mh) mh.classList.add('hidden'); });

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW registered')).catch(()=>console.log('SW failed'));
}
</script>
</body>
</html>