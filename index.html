<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Joc de l'Edat Mitjana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#7c3aed" />
  <style>
    .card-shadow { box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
    .emoji-small { font-size: 1.5rem; line-height:1; }
    .num-badge { width:2rem; display:inline-block; font-weight:700; text-align:center }
    .correct-glow { animation: correctPulse 0.9s ease forwards; }
    .wrong-shake { animation: wrongShake .6s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes correctPulse { 0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)} }
    @keyframes wrongShake { 10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(4px)} }
  </style>
</head>
<body class="bg-gradient-to-br from-yellow-100 to-yellow-300 min-h-screen flex items-center justify-center p-4">

  <div id="app" class="w-full max-w-xl"></div>

  <script>
    // --- Source text (kept in a JS string using backticks; contains apostrophes safely) ---
    const originalText = `La Edad Mitjana √©s una √®poca de la hist√≤ria que va comen√ßar despr√©s de l'Imperi Rom√† i va acabar quan van descobrir Am√®rica.
Durant aquest temps:
Els castells eren molt importants. Hi vivien els reis, els nobles i els cavallers.
A prop dels castells hi havia els pobles, on vivien els pagesos, que treballaven al camp.
Les ciutats eren petites i moltes vegades tenien muralles per protegir-se.
Les persones resaven a D√©u i anaven a l'esgl√©sia. Els monjos vivien als monestirs, on copiaven llibres i estudiaven.
No hi havia m√†quines ni llum el√®ctrica, i les persones feien servir animals per treballar i espelmes per il¬∑luminar-se.
Cap al final de l'Edat Mitjana, les ciutats van cr√©ixer, van apar√®ixer els mercats i es van comen√ßar a fer viatges per comerciar.`;

    // --- Sounds ---
    // correctSound uses the pixabay link user requested; we try it and fallback if blocked
    const correctSound = new Audio();
    correctSound.src = "https://cdn.pixabay.com/download/audio/2021/09/20/audio_84f81f8d42.mp3";
    correctSound.addEventListener('error', ()=> { correctSound.src = 'https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'; });
    // wrong sound kept simple
    const wrongSound = new Audio('https://actions.google.com/sounds/v1/cartoon/boing.ogg');

    // --- Questions (50) ---
    // These are simple, kid-friendly and based on originalText. Each choice includes an emoji.
    const QUESTIONS = [
      { q: "Quan comen√ßa l'Edat Mitjana?", opts:["Despr√©s de l'Imperi Rom√† üï∞Ô∏è","Abans dels dinosaures ü¶ï","Al futur ü§ñ"], correct:0 },
      { q: "Qui vivia als castells?", opts:["Reis, nobles i cavallers üëë","Pagesos üåæ","Pescadors üé£"], correct:0 },
      { q: "On vivien els pagesos?", opts:["Als pobles prop dels castells üèòÔ∏è","A la ciutat gran üèôÔ∏è","A la platja üèñÔ∏è"], correct:0 },
      { q: "Com eren moltes ciutats?", opts:["Petites i amb muralles üß±","Molt modernes üè¢","Submergides üåä"], correct:0 },
      { q: "On anaven les persones a resar?", opts:["A l'esgl√©sia ‚õ™","Al parc üå≥","Al mercat üõçÔ∏è"], correct:0 },
      { q: "On vivien els monjos?", opts:["Als monestirs üìú","Als teatres üé≠","Al port ‚õµ"], correct:0 },
      { q: "Qu√® feien els monjos amb els llibres?", opts:["Els copiaven ‚úçÔ∏è","Els cremaven üî•","Els llen√ßaven üóëÔ∏è"], correct:0 },
      { q: "Hi havia llum el√®ctrica?", opts:["No, espelmes üïØÔ∏è","S√≠, com ara üí°","Nom√©s de nit üåô"], correct:0 },
      { q: "Amb qu√® treballaven al camp?", opts:["Amb animals üêÇ","Amb tractors üöú","Amb robots ü§ñ"], correct:0 },
      { q: "Com s'il¬∑luminaven a casa?", opts:["Amb espelmes üïØÔ∏è","Amb bombetes üí°","Amb l√†sers üî¶"], correct:0 },

      { q: "Quan va acabar l'Edat Mitjana (segons el text)?", opts:["Quan es va descobrir Am√®rica üåé","Quan van apar√®ixer cotxes üöó","Quan va comen√ßar el cinema üé¨"], correct:0 },
      { q: "Qu√® hi havia a prop dels castells?", opts:["Pobles amb pagesos üèòÔ∏è","Castells moderns üè¢","Aeroports ‚úàÔ∏è"], correct:0 },
      { q: "Per qu√® tenien muralles les ciutats?", opts:["Per protegir-se üõ°Ô∏è","Per decorar üé®","Per jugar üèÄ"], correct:0 },
      { q: "Qu√® feien els pagesos?", opts:["Treballar al camp üåæ","Navegar a l'espai üöÄ","Cantar can√ßons üé§"], correct:0 },
      { q: "Qu√® no hi havia a l'Edat Mitjana?", opts:["Electricitat a les cases ‚ö°","Animals üêÆ","Castells üè∞"], correct:0 },
      { q: "Qu√® va apar√®ixer cap al final?", opts:["Mercats i comer√ß üõçÔ∏è","Autom√≤bils massius üöó","Robots a casa ü§ñ"], correct:0 },
      { q: "Per qu√® feien viatges?", opts:["Per comerciar ‚õµ","Per passejar a la Lluna üåï","Per fer esports üèÑ"], correct:0 },
      { q: "Qui vivia als monestirs?", opts:["Monjos üìò","Artistes üé®","Fusters ü™ì"], correct:0 },
      { q: "Qu√® utilitzaven per il¬∑luminar-se?", opts:["Espelmes üïØÔ∏è","Faroles modernes üí°","Pantalles üì±"], correct:0 },
      { q: "Qu√® era molt important?", opts:["Els castells üè∞","Els gratacels üè¢","Les f√†briques üè≠"], correct:0 },

      { q: "On vivien els reis?", opts:["Als castells üè∞","Als xalets üè°","Als apartaments üè¢"], correct:0 },
      { q: "Quina estructura defensiva tenien moltes ciutats?", opts:["Muralles üß±","Pals de fusta ü™µ","Globus aerost√†tics üéà"], correct:0 },
      { q: "Qu√® feien amb els llibres als monestirs?", opts:["Els copiaven a m√† ‚úçÔ∏è","Els pintaven de colors üé®","Els venien a mercat üß∫"], correct:0 },
      { q: "Com viatjaven sovint?", opts:["Amb vaixell o carro ‚õµ","Amb cotxe üöó","Amb avi√≥ ‚úàÔ∏è"], correct:0 },
      { q: "Qu√® passava amb les ciutats cap al final?", opts:["Creixien i tenien mercats üèôÔ∏è","S'evaporaven üí®","Es feien petites üßä"], correct:0 },
      { q: "Qui treballava al camp?", opts:["Pagesos üåæ","Mercaders üß∫","Nobles üëë"], correct:0 },
      { q: "Quin tipus de llum NO era com√∫ a les cases?", opts:["Electricitat üí°","Espelmes üïØÔ∏è","Torxes üî•"], correct:0 },
      { q: "Qu√® s'utilitzava per tirar i carregar?", opts:["Animals de tracci√≥ üêÇ","Tractors moderns üöú","M√†quines el√®ctriques ‚öôÔ∏è"], correct:0 },
      { q: "On es copiaven llibres i s'estudiava?", opts:["Als monestirs üìö","A l'aire lliure üå§Ô∏è","Als gimnassos üèãÔ∏è"], correct:0 },
      { q: "Qu√® copiaven sovint els monjos?", opts:["Llibres i textos üìñ","Jocs üéÆ","Revistes modernes üóûÔ∏è"], correct:0 },

      { q: "Com eren les muralles?", opts:["Grans i resistents üß±","Fines com paper üìÑ","De gel ‚ùÑÔ∏è"], correct:0 },
      { q: "Qu√® es feia als mercats?", opts:["Comerciar üõí","Anar al cinema üé¨","Fer esports üèÄ"], correct:0 },
      { q: "Quin transport era com√∫?", opts:["Cavalls i carros üêé","Cotxes üöó","Helic√≤pters üöÅ"], correct:0 },
      { q: "Com eren la majoria de ciutats?", opts:["Petites üèòÔ∏è","Gigants üèôÔ∏è","Submergides üåä"], correct:0 },
      { q: "On es practicava la religi√≥?", opts:["A l'esgl√©sia ‚õ™","Al cinema üé¨","Al supermercat üõí"], correct:0 },
      { q: "Qui governava sovint?", opts:["Reis i nobles üëë","Ca√ßadors üèπ","Exploradors üß≠"], correct:0 },
      { q: "Qu√® no hi havia als pobles?", opts:["Cotxes üöó","Pagesos üåæ","Animals dom√®stics üêÆ"], correct:0 },
      { q: "Qu√® copiaven als monestirs?", opts:["Textos i llibres üìú","Fulletons moderns üì∞","Men√∫s üçΩÔ∏è"], correct:0 },
      { q: "Qu√® va cr√©ixer al final de l'√®poca?", opts:["Mercats i comer√ß üè™","Televisi√≥ üì∫","Internet üåê"], correct:0 },
      { q: "Com s'il¬∑luminaven les cases?", opts:["Espelmes üïØÔ∏è","Llanternes üî¶","LED modernes üí°"], correct:0 }
    ];

    // --- Game state ---
    let gameQuestions = [];
    let currentIndex = 0;
    let correctCount = 0;
    let wrongCount = 0;

    // --- Helpers ---
    function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

    // Create UI once and then manipulate
    const app = document.getElementById('app');

    function createInitialUI(){
      app.innerHTML = '';

      // Start screen
      const start = document.createElement('div');
      start.id = 'screen-start';
      start.className = 'card-shadow bg-white rounded-2xl p-8 text-center';
      start.innerHTML = `
        <div class="text-6xl mb-3">üè∞</div>
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">Joc: L'Edat Mitjana</h1>
        <p class="text-gray-600 mb-6">Preguntes f√†cils per a nens i nenes. Cada partida: 5 preguntes.</p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <button id="btn-start" class="px-6 py-3 rounded-xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700">Comen√ßar</button>
          <button id="btn-view-text" class="px-6 py-3 rounded-xl bg-amber-400 text-amber-900 font-semibold shadow hover:bg-amber-500">Veure text original</button>
          <button id="btn-history" class="px-6 py-3 rounded-xl bg-green-400 text-green-900 font-semibold shadow hover:bg-green-500">Historial</button>
        </div>
      `;
      app.appendChild(start);

      // Modal for original text
      const modalText = document.createElement('div');
      modalText.id = 'modal-text';
      modalText.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden';
      modalText.innerHTML = `<div class="bg-white rounded-xl shadow-xl max-w-3xl w-full p-6"><div class="flex justify-between items-start"><h2 class="text-xl font-bold text-indigo-700">Text original</h2><button id="close-text" class="text-gray-500 hover:text-gray-800">Tancar ‚úñ</button></div><div class="mt-4 text-gray-800 leading-relaxed"><pre id="original-pre" class="whitespace-pre-wrap"></pre></div></div>`;
      app.appendChild(modalText);
      document.getElementById('original-pre').textContent = originalText;

      // History modal
      const modalHistory = document.createElement('div');
      modalHistory.id = 'modal-history';
      modalHistory.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden';
      modalHistory.innerHTML = `<div class="bg-white rounded-xl shadow-xl max-w-3xl w-full p-6"><div class="flex justify-between items-start"><h2 class="text-xl font-bold text-green-700">Historial</h2><div class="flex gap-2"><button id="clear-history" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded">Esborrar</button><button id="close-history" class="text-gray-500 hover:text-gray-800">Tancar ‚úñ</button></div></div><div id="history-list" class="mt-4 text-gray-800 max-h-64 overflow-auto"></div></div>`;
      app.appendChild(modalHistory);

      // Game screen
      const game = document.createElement('div');
      game.id = 'screen-game';
      game.className = 'hidden mt-6';
      game.innerHTML = `
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="text-4xl">üß≠</div>
              <div>
                <div class="text-sm text-gray-500">Pregunta <span id="q-index">1</span> / 5</div>
                <div id="progress" class="w-48 h-2 bg-gray-200 rounded-full mt-2 overflow-hidden"><div id="progress-bar" class="h-full bg-indigo-500 w-0"></div></div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-600">Aciertos: <span id="score-correct">0</span></div>
              <div class="text-sm text-gray-600">Errors: <span id="score-wrong">0</span></div>
            </div>
          </div>

          <div id="card" class="rounded-lg p-6 bg-gradient-to-br from-white to-slate-50 border border-gray-100 card-shadow">
            <div class="mb-4">
              <div class="text-2xl font-semibold text-indigo-700 mb-3" id="question-text">Pregunta aqu√≠</div>
              <div class="text-sm text-gray-500 mb-2">Escull la resposta: 1, 2 o 3</div>
            </div>

            <div id="answers" class="grid gap-3"></div>

            <div class="mt-5 flex justify-between items-center">
              <div class="text-sm text-gray-500">Utilitza 1-2-3 o el ratol√≠</div>
              <div class="flex gap-3">
                <button id="btn-accept" class="px-5 py-2 rounded-xl bg-indigo-600 text-white font-semibold disabled:opacity-50" disabled>Acceptar</button>
                <button id="btn-next" class="px-5 py-2 rounded-xl bg-gray-300 text-gray-800 hidden">Seg√ºent pregunta</button>
              </div>
            </div>
          </div>
        </div>
      `;
      app.appendChild(game);

      // Result screen
      const result = document.createElement('div');
      result.id = 'screen-result';
      result.className = 'hidden mt-6';
      result.innerHTML = `
        <div class="bg-white rounded-2xl p-6 card-shadow text-center">
          <div class="text-6xl mb-3" id="result-emoji">üéâ</div>
          <h3 class="text-2xl font-extrabold text-indigo-700" id="result-title">Has acabat!</h3>
          <p class="mt-2 text-gray-700">Aciertos: <span id="final-correct">0</span> ‚Äî Errors: <span id="final-wrong">0</span></p>
          <div class="mt-6 flex justify-center gap-3">
            <button id="btn-play-again" class="px-5 py-2 rounded-xl bg-indigo-600 text-white">Jugar de nou</button>
            <button id="btn-back-home" class="px-5 py-2 rounded-xl bg-amber-400 text-amber-900">Tornar</button>
          </div>
        </div>
      `;
      app.appendChild(result);

      // Wire up basic buttons
      document.getElementById('btn-start').addEventListener('click', ()=> startGame());
      document.getElementById('btn-view-text').addEventListener('click', ()=> document.getElementById('modal-text').classList.remove('hidden'));
      document.getElementById('close-text').addEventListener('click', ()=> document.getElementById('modal-text').classList.add('hidden'));
      document.getElementById('btn-history').addEventListener('click', ()=> { renderHistory(); document.getElementById('modal-history').classList.remove('hidden'); });
      document.getElementById('close-history').addEventListener('click', ()=> document.getElementById('modal-history').classList.add('hidden'));
      document.getElementById('clear-history').addEventListener('click', ()=> { if(confirm('Esborrar historial?')){ localStorage.removeItem('medieval_scores'); renderHistory(); }});

      document.getElementById('btn-play-again').addEventListener('click', ()=> startGame());
      document.getElementById('btn-back-home').addEventListener('click', ()=> showScreen('start'));

      document.getElementById('btn-accept').addEventListener('click', ()=> { if(selectedChoiceIndex===null) return; verifyAnswer(); });
      document.getElementById('btn-next').addEventListener('click', ()=> { document.getElementById('btn-next').classList.add('hidden'); proceedToNext(); });

      // keyboard support
      document.addEventListener('keydown', (e)=>{
        if(!document.getElementById('screen-game').classList.contains('hidden')){
          if(['1','2','3'].includes(e.key)){
            const idx = parseInt(e.key,10)-1;
            const btns = document.querySelectorAll('#answers button');
            if(btns[idx]) btns[idx].click();
          } else if(e.key==='Enter'){
            if(!document.getElementById('btn-accept').disabled) document.getElementById('btn-accept').click();
          }
        }
      });
    }

    // --- Game functions ---
    let selectedChoiceIndex = null;

    function startGame(){
      gameQuestions = shuffle(QUESTIONS).slice(0,5);
      currentIndex = 0;
      correctCount = 0;
      wrongCount = 0;
      document.getElementById('score-correct').textContent = '0';
      document.getElementById('score-wrong').textContent = '0';
      document.getElementById('progress-bar').style.width = '0%';
      showScreen('game');
      renderQuestion();
    }

    function renderQuestion(){
      const q = gameQuestions[currentIndex];
      document.getElementById('q-index').textContent = (currentIndex+1);
      document.getElementById('progress-bar').style.width = ((currentIndex/5)*100)+'%';
      document.getElementById('question-text').textContent = q.q;
      const answers = document.getElementById('answers');
      answers.innerHTML = '';
      selectedChoiceIndex = null;
      document.getElementById('btn-accept').disabled = true;
      document.getElementById('btn-next').classList.add('hidden');

      // shuffle choices and render with number + emoji
      const opts = q.opts.map((t,i)=>({text:t, orig:i}));
      const shuffled = shuffle(opts);
      shuffled.forEach((opt,i)=>{
        // split last token emoji if present
        const parts = opt.text.split(' ');
        let emoji = parts[parts.length-1];
        let text = parts.slice(0,-1).join(' ');
        if(!text) { text = opt.text; emoji = 'üîπ'; }

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'answer-btn text-left border rounded-lg px-4 py-3 flex items-center gap-3 bg-white';
        btn.innerHTML = `<span class="num-badge">${i+1}</span><span class="emoji-small">${emoji}</span><span class="flex-1">${text}</span>`;
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('#answers button').forEach(b=> b.classList.remove('ring-2','ring-indigo-300'));
          btn.classList.add('ring-2','ring-indigo-300');
          selectedChoiceIndex = i;
          // store which original index this button represents
          btn.dataset.orig = opt.orig;
          document.getElementById('btn-accept').disabled = false;
        });
        answers.appendChild(btn);
      });
    }

    function verifyAnswer(){
      const q = gameQuestions[currentIndex];
      const btns = document.querySelectorAll('#answers button');
      if(selectedChoiceIndex===null) return;
      // find the selected button (by ring class)
      let selectedBtn = null;
      btns.forEach(b=>{ if(b.classList.contains('ring-2')) selectedBtn = b; b.disabled = true; });
      const chosenOrig = parseInt(selectedBtn.dataset.orig,10);
      const isCorrect = chosenOrig === q.correct;
      if(isCorrect){
        correctCount++;
        document.getElementById('score-correct').textContent = correctCount;
        selectedBtn.classList.add('bg-green-100','border-green-300');
        try{ correctSound.currentTime = 0; correctSound.play(); }catch(e){}
        // short delay then next
        setTimeout(()=>{ proceedToNext(); }, 800);
      } else {
        wrongCount++;
        document.getElementById('score-wrong').textContent = wrongCount;
        // mark correct and wrong
        btns.forEach(b=>{
          const orig = parseInt(b.dataset.orig,10);
          if(orig === q.correct) b.classList.add('bg-green-100','border-green-300');
          else if(b.classList.contains('ring-2')) b.classList.add('bg-red-100','border-red-300');
          else b.classList.add('bg-gray-50');
        });
        try{ wrongSound.currentTime = 0; wrongSound.play(); }catch(e){}
        // show next button and wait for user
        document.getElementById('btn-next').classList.remove('hidden');
      }
    }

    function proceedToNext(){
      currentIndex++;
      if(currentIndex>=5){ finishGame(); }
      else { renderQuestion(); }
    }

    function finishGame(){
      document.getElementById('progress-bar').style.width = '100%';
      document.getElementById('final-correct').textContent = correctCount;
      document.getElementById('final-wrong').textContent = wrongCount;
      // simple messages
      const title = document.getElementById('result-title');
      const emoji = document.getElementById('result-emoji');
      if(correctCount >= 4){ emoji.textContent = 'üèÜ'; title.textContent = 'Super! Molt b√©!'; }
      else if(correctCount >= 2){ emoji.textContent = 'üôÇ'; title.textContent = 'Bona feina!'; }
      else { emoji.textContent = 'ü§î'; title.textContent = "Hem d'estudiar una mica m√©s"; }

      // save in localStorage
      try{
        const hist = JSON.parse(localStorage.getItem('medieval_scores')||'[]');
        hist.unshift({ date: new Date().toISOString(), correct: correctCount, wrong: wrongCount });
        localStorage.setItem('medieval_scores', JSON.stringify(hist.slice(0,50)));
      }catch(e){ console.warn("No s'ha pogut guardar historial", e); }

      showScreen('result');
    }

    function showScreen(name){
      document.getElementById('screen-start').classList.toggle('hidden', name!=='start');
      document.getElementById('screen-game').classList.toggle('hidden', name!=='game');
      document.getElementById('screen-result').classList.toggle('hidden', name!=='result');
      if(name==='start') document.getElementById('progress-bar').style.width = '0%';
    }

    function renderHistory(){
      const list = JSON.parse(localStorage.getItem('medieval_scores')||'[]');
      const container = document.getElementById('history-list');
      container.innerHTML = '';
      if(!list.length) return container.innerHTML = '<p class="text-gray-600">No hi ha resultats encara.</p>';
      list.slice(0,20).forEach((s,i)=>{
        const d = new Date(s.date);
        const el = document.createElement('div');
        el.className = 'p-3 bg-gray-50 rounded mb-2 flex justify-between items-center';
        el.innerHTML = `<div><div class="text-sm font-medium">Partida ${i+1}</div><div class="text-xs text-gray-500">${d.toLocaleString()}</div></div><div class="text-sm"><span class="font-semibold text-green-600">${s.correct}</span> ‚úî ‚Äî <span class="font-semibold text-red-600">${s.wrong}</span> ‚úñ</div>`;
        container.appendChild(el);
      });
    }

    // Initialize
    createInitialUI();
    showScreen('start');

  </script>
</body>
</html>